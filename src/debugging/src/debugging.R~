###Debugging

###enaR

##enaEnviron
##Re-program from scratch...?

library(enaR)
data(oyster)

###Go back to 1.01 and match output to Dave's
                                        #making checks
F <- matrix(c(0,0,0,0,0,0,
              15.7915,0,0,4.2403,1.9076,0.3262,
              0,8.1721,0,0,0,0,
              0,7.2745,1.2060,0.6609,0,0,
              0,0.6431,1.2060,0.6609,0,0,
              0.5135,0,0,0,0.1721,0),
            nrow=6,ncol=6,byrow=TRUE)
z <- c(41.4697,0,0,0,0,0)
y <- c(25.1647,6.1759,5.7601,3.5793,0.4303,0.3594)
x <- 1e3 * c(2,1,0.0024,0.0241,0.0163,0.0692)
                                        #structural
A <- matrix(c(0,1,0,0,0,1,
              0,0,1,1,1,0,
              0,0,0,1,1,0,
              0,1,0,0,1,0,
              0,1,0,0,0,1,
              0,1,0,0,0,0),
            nrow=6)
A1 <- matrix(c(1,1,0,0,0,1,
               0,1,1,1,1,0,
               0,0,1,1,1,0,
               0,1,0,1,1,0,
               0,1,0,0,1,1,
               0,1,0,0,0,1),
             nrow=6)
                                        #throughflow
T <- c(41.4697,22.2656,8.1721,8.4805,2.5100,0.6856)
G <- matrix(c(0,0.3808,0,0,0,0.0124,
              0,0,0.3670,0.3267,0.0289,0,
              0,0,0,0.1476,0.1476,0,
              0,0.5000,0,0,0.0779,0,
              0,0.7600,0,0,0,0.0686,
              0,0.4758,0,0,0,0),
            nrow=6)
GP <- matrix(c(0,0.7092,0,0,0,0.7490,
               0,0,1.0000,0.8578,0.2562,0,
               0,0,0,0.1422,0.4805,0,
               0,0.1904,0,0,0.2633,0,
               0,0.0857,0,0,0,0.2510,
               0,0.0147,0,0,0,0),
             nrow=6)
N <- matrix(c(1.0000,0.5369,0.1971,0.2045,0.0605,0.0165,
              0,1.3885,0.5096,0.5288,0.1565,0.0107,
              0,0.2775,1.1019,0.2533,0.1904,0.0131,
              0,0.7800,0.2863,1.2971,0.1659,0.0114,
              0,1.1006,0.4039,0.4192,1.1241,0.0771,
              0,0.6606,0.2425,0.2516,0.0745,1.0051),
            nrow=6)
NP <- matrix(c(1,1,1,1,1,1,
               0,1.3885,1.3885,1.3885,1.3885,0.3485,
               0,0.1019,1.1019,0.2441,0.6198,0.1556,
               0,0.2971,0.2971,1.2971,0.5604,0.1407,
               0,0.1241,0.1241,0.1241,1.1241,0.2811,
               0,0.0203,0.0203,0.0203,0.0203,1.0051),
             nrow=6)
                                        #storage
C <- matrix(c(-0.0207,0.0079,0,0,0,0.003,
              0,-0.0223,0.0082,0.0073,0.0006,0,
              0,0,-3.3880,0.5000,0.5000,0,
              0,0.1758,0,-0.3516,0.0274,0,
              0,0.1172,0,0,-0.1542,0.0106,
              0,0.0047,0,0,0,-0.0099),
            nrow=6)
CP <- matrix(c(-0.0207,0.0158,0,0,0,0.0074,
               0,-0.0223,3.3880,0.3016,0.0395,0,
               0,0,-3.3880,0.0500,0.0741,0,
               0,0.0042,0,-0.3516,0.04406,0,
               0,0.0019,0,0,-0.1542,0.0025,
               0,0.003,0,0,0,-0.0099),
             nrow=6)

## S <- matrix(c(
##               ),
##             nrow=6)
                                        #Control

                                        #Utility

                                        #Environs
                                        #Flow
                                        #Output
E <- array(0,dim=c(nrow(F)+1,ncol(F)+1,nrow(F)))
E[,,1] <- matrix(c(
                   -1.0000,0,0,0,0,0,1.0000,
                   0.3808,-0.5369,0,0.1023,0.0460,0.0079,0,
                   0,0.1971,-0.1971,0,0,0,0,
                   0,0.1754,0.0291,-0.2045,0,0,0,
                   0,0.0155,0.0291,0.0159,-0.0605,0,0,
                   0.0124,0,0,0,0.0042,-0.0165,0,
                   0.6068,0.1489,0.1389,0.0863,0.0104,0.0087,0
              ),
            nrow=7,byrow=TRUE)
E[,,2] <- matrix(c(
                   0,0,0,0,0,0,0,
                   0,-1.3885,0.5096,0.4536,0.0401,0,0.3851,
                   0,0,-0.5096,0.0752,0.0752,0,0.3592,
                   0,0.2644,0,-0.5288,0.0412,0,0.2232,
                   0,0.1190,0,0,-0.1565,0.0107,0.0268,
                   0,0.0051,0,0,0,-0.0107,0.0065,
                   0,1.0000,0,0,0,0,0),
                 nrow=7)
                                        #Flow
                                        #Input
EP <- array(0,dim=c(nrow(F)+1,ncol(F)+1,nrow(F)))
EP[,,1] <- matrix(c(
                   -1,0,0,0,0,0,1,
                   0,0,0,0,0,0,0,
                   0,0,0,0,0,0,0,
                   0,0,0,0,0,0,0,
                   0,0,0,0,0,0,0,
                   0,0,0,0,0,0,0,
                   1,0,0,0,0,0,0),
                 nrow=7)
EP[,,2] <- matrix(c(
                    -1.0000,0.9848,0,0,0,0.0152,0,
                    0,-1.3885,0.1019,0.2548,0.0318,0,1.0000,
                    0,0,-0.1019,0.0422,0.0596,0,0,
                    0,0.2644,0,-0.2971,0.0327,0,0,
                    0,0.1190,0,0,-0.1241,0.0051,0,
                    0,0.0203,0,0,0,-0.0203,0,
                    1.0000,0,0,0,0,0,0),
                  nrow=7)
                                        #storage
                                        #output
SE <- array(0,dim=c(nrow(F)+1,ncol(F)+1,nrow(F)))
SE[,,1] <- matrix(c(
                    -1.0000,0.3808,0,0,0,0.0124,0.6068,
                    0,-0.5369,0.1971,0.1754,0.0155,0,0.1489,
                    0,0,-0.1971,0.0291,0.0291,0,0.1389,
                    0,0.1023,0,-0.2045,0.0159,0,0.0863,
                    0,0.0460,0,0,-0.0605,0.0042,0.0104,
                    0,0.0079,0,0,0,-0.0165,0.0087,
                    1.0000,0,0,0,0,0,0),
                  nrow=7)
SE[,,2] <- matrix(c(
                    0,0,0,0,0,0,0,
                    0,-1.3885,0.5096,0.4536,0.0401,0,0.3851,
                    0,0,-0.5096,0.0752,0.0752,0,0.3592,
                    0,0.2644,0,-0.5288,0.0412,0,0.2232,
                    0,0.1190,0,0,-0.1565,0.0107,0.0268,
                    0,0.0051,0,0,0,-0.0107,0.0056,
                    0,1.0000,0,0,0,0,0),
                  nrow=7)

                                        #storage
                                        #input
SEP <- array(0,dim=c(nrow(F)+1,ncol(F)+1,nrow(F)))
SEP[,,1] <- matrix(c(
                     -1,0,0,0,0,0,1,
                     0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,
                     0,0,0,0,0,0,0,
                     1,0,0,0,0,0,0),
                   nrow=7)
SEP[,,2] <- matrix(c(
                     -1.0000,0.9848,0,0,0,0.0152,0,
                     0,-1.3885,0.1019,0.2548,0.0318,0,1.0000,
                     0,0,-0.1019,0.0422,0.0596,0,0,
                     0,0.2644,0,-0.2971,0.0327,0,0,
                     0,0.1190,0,0,-0.1241,0.0051,0,
                     0,0.0203,0,0,0,-0.0203,0,
                     1.0000,0,0,0,0,0,0),
                   nrow=7)
                                        #dame and patten 1981 ordering
data(oyster)
dp.order <- c(1,3,4,5,6,2)
o.flow <- oyster%n%'flow'
o.flow <- o.flow[order(dp.order),order(dp.order)]
t(o.flow)
(oyster%v%'input')[order(dp.order)]
(oyster%v%'output')[order(dp.order)]
(oyster%v%'storage')[order(dp.order)]
                                        #Structure
t(enaStructure(oyster)$A)[order(dp.order),order(dp.order)]
                                        #Flow
names(enaFlow(oyster))
enaFlow(oyster)$T[order(dp.order)]
t(enaFlow(oyster)$G[order(dp.order),order(dp.order)])
t(enaFlow(oyster)$GP[order(dp.order),order(dp.order)])
t(enaFlow(oyster)$N[order(dp.order),order(dp.order)])
t(enaFlow(oyster)$NP[order(dp.order),order(dp.order)])
                                        #Storage
names(enaStorage(oyster))
enaStorage(oyster)$X[order(dp.order)]
t(enaStorage(oyster)$C[order(dp.order),order(dp.order)])
t(enaStorage(oyster)$CP[order(dp.order),order(dp.order)])
t(enaStorage(oyster)$S[order(dp.order),order(dp.order)])
t(enaStorage(oyster)$SP[order(dp.order),order(dp.order)])
t(enaStorage(oyster)$P[order(dp.order),order(dp.order)])
t(enaStorage(oyster)$PP[order(dp.order),order(dp.order)])
t(enaStorage(oyster)$Q[order(dp.order),order(dp.order)])
round(t(enaStorage(oyster)$QP[order(dp.order),order(dp.order)]),5)

t(enaStorage(oyster)$C[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$C[order(dp.order),order(dp.order)]))<0]
t(enaStorage(oyster)$CP[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$CP[order(dp.order),order(dp.order)]))<0]
t(enaStorage(oyster)$SP[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$SP[order(dp.order),order(dp.order)]))<0]
t(enaStorage(oyster)$P[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$P[order(dp.order),order(dp.order)]))<0]
t(enaStorage(oyster)$PP[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$PP[order(dp.order),order(dp.order)]))<0]
t(enaStorage(oyster)$Q[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$Q[order(dp.order),order(dp.order)]))<0]
t(enaStorage(oyster)$QP[order(dp.order),order(dp.order)])[sign(t(enaStorage(oyster)$QP[order(dp.order),order(dp.order)]))<0]

                                        #Control
round(t(enaControl(oyster)$CN)[order(dp.order),order(dp.order)],7)
round(t(enaControl(oyster)$CQ)[order(dp.order),order(dp.order)],7)
                                        #Utility
U <- enaUtility(oyster)
names(U)
t(U$D)[order(dp.order),order(dp.order)]
t(U$U)[order(dp.order),order(dp.order)]
t(U$Y)[order(dp.order),order(dp.order)]
                                        #Environ
env <- enaEnviron(oyster)
env.in <- env[[1]][order(dp.order)]
env.out <- env[[2]][order(dp.order)]
t(env.out[[1]])[order(dp.order),order(dp.order)]
t(env.in[[1]])[order(dp.order),order(dp.order)]


                                        #
x <- read.scor('../data/CFRE_HB_summer_ghost.dat')
plot(x,displaylabels=TRUE)
ssCheck(x)
hist(x%n%'flow')
env.out <- enaEnviron(x)
                                        #compare v1.03 to v2.1
v103 <- dget('./results/env_out_v1_03.Rdata')
v21 <- dget('./results/env_out_v2_1.Rdata')
v103[[1]][[1]]-v21[[1]][[1]]
v103[[1]][[1]]-t(v21[[1]][[1]])
                                        #compare v2.0 to 1.01
source('~/projects/debugging/diff/enaR101/R/environ.R')
env101 <- environ
source('~/projects/debugging/diff/enaR200/R/enaEnviron.R')
env200 <- enaEnviron
load('~/projects/enaR/data/oyster.rda')
env101(oyster)[[1]][[2]]
env200(x,type='realized')[[1]][[11]]
                                        #use dave's function that works
                                        #go back to a version that works
